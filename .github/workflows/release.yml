name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Production Assets
        run: npm run build

      - name: Bench (DB sanity + JSON output)
        run: npm run bench

      - name: Package Installers
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Phase 5: Packaged Build Smoke (pre-publish gate) ──────────────────
      - name: Package Fixtures (generate ZIPs for smoke)
        run: node scripts/package_fixtures.js

      - name: Phase 5 — Smoke ChatGPT
        shell: pwsh
        run: |
          $vault = Join-Path $env:RUNNER_TEMP "vault_smoke_chatgpt"
          New-Item -ItemType Directory -Force -Path $vault | Out-Null
          $exe = Get-ChildItem dist -Recurse -File -Filter "*.exe" |
            Where-Object { $_.FullName -match "win-unpacked" } |
            Select-Object -First 1
          if (-not $exe) { throw "Could not find unpacked exe under dist/win-unpacked" }
          & $exe.FullName --smoke --vault-dir $vault --import "tests/fixtures/chatgpt_export.zip" --sentinel SENTINEL_CHATGPT_001 --provider chatgpt --smoke-out dist/smoke_chatgpt.json | Out-Default
          if ($LASTEXITCODE -ne 0) { throw "Smoke ChatGPT failed (exit $LASTEXITCODE)" }

      - name: Phase 5 — Smoke Claude
        shell: pwsh
        run: |
          $vault = Join-Path $env:RUNNER_TEMP "vault_smoke_claude"
          New-Item -ItemType Directory -Force -Path $vault | Out-Null
          $exe = Get-ChildItem dist -Recurse -File -Filter "*.exe" |
            Where-Object { $_.FullName -match "win-unpacked" } |
            Select-Object -First 1
          if (-not $exe) { throw "Could not find unpacked exe under dist/win-unpacked" }
          & $exe.FullName --smoke --vault-dir $vault --import "tests/fixtures/claude_export.zip" --sentinel SENTINEL_CLAUDE_001 --provider claude --smoke-out dist/smoke_claude.json | Out-Default
          if ($LASTEXITCODE -ne 0) { throw "Smoke Claude failed (exit $LASTEXITCODE)" }

      - name: Phase 5 — Smoke Gemini
        shell: pwsh
        run: |
          $vault = Join-Path $env:RUNNER_TEMP "vault_smoke_gemini"
          New-Item -ItemType Directory -Force -Path $vault | Out-Null
          $exe = Get-ChildItem dist -Recurse -File -Filter "*.exe" |
            Where-Object { $_.FullName -match "win-unpacked" } |
            Select-Object -First 1
          if (-not $exe) { throw "Could not find unpacked exe under dist/win-unpacked" }
          & $exe.FullName --smoke --vault-dir $vault --import "tests/fixtures/gemini_export.zip" --sentinel SENTINEL_GEMINI_001 --provider gemini --smoke-out dist/smoke_gemini.json | Out-Default
          if ($LASTEXITCODE -ne 0) { throw "Smoke Gemini failed (exit $LASTEXITCODE)" }

      - name: Generate SHA256SUMS.txt (release assets only)
        shell: pwsh
        run: |
          $dist = "dist"
          $out  = "$dist/SHA256SUMS.txt"
          if (-not (Test-Path $dist)) { throw "dist/ not found. Packaging likely failed." }
          if (Test-Path $out) { Remove-Item $out -Force }

          $assets = Get-ChildItem -Path $dist -File | Where-Object { $_.Name -match '\.(exe|zip)$' -or $_.Name -match '^smoke_.*\.json$' } | Sort-Object Name -Unique
          $files = @($assets)

          if ($files.Count -eq 0) { throw "No release artifacts found in dist/ to checksum." }

          $lines = New-Object System.Collections.Generic.List[string]
          foreach ($f in $files) {
            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.ToLower()
            $lines.Add("$hash  $($f.Name)")
          }

          # Write with LF line endings and UTF-8 (No BOM) for max compatibility
          $text = ($lines -join "`n") + "`n"
          $utf8 = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText($out, $text, $utf8)

      - name: Verify Checksums in CI
        shell: pwsh
        run: |
          $dist = "dist"
          $sumFile = Join-Path $dist "SHA256SUMS.txt"
          if (-not (Test-Path $sumFile)) { throw "SHA256SUMS.txt was not generated." }

          $lines = Get-Content $sumFile
          foreach ($line in $lines) {
            if ($line.Trim().Length -eq 0) { continue }
            # Split with limit of 2 to handle filenames with multiple spaces
            $parts = $line -split "\s{2,}", 2
            if ($parts.Count -lt 2) { throw "Malformed checksum line: $line" }

            $expected = $parts[0].ToLower()
            $name = $parts[1]
            $path = Join-Path $dist $name
            if (-not (Test-Path $path)) { throw "Missing file referenced by checksum: $name" }

            $actual = (Get-FileHash $path -Algorithm SHA256).Hash.ToLower()
            if ($actual -ne $expected) {
              throw "Checksum mismatch for $name (Expected: $expected, Actual: $actual)"
            }
            Write-Host "✅ Verified $name"
          }

      - name: Upload benchmark.json (CI artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark
          path: dist/benchmark.json
          if-no-files-found: warn

      - name: Collect Release Assets
        id: relfiles
        shell: pwsh
        run: |
          $dist = "dist"
          $assets = Get-ChildItem -Path $dist -File | Where-Object { $_.Name -match '\.(exe|zip)$' -or $_.Name -match '^smoke_.*\.json$' } | Sort-Object Name -Unique
          if ($assets.Count -eq 0) { throw "No .exe, .zip, or smoke artifacts found in dist/." }

          $paths = @()
          foreach ($a in $assets) { $paths += "dist/$($a.Name)" }
          $paths += "dist/SHA256SUMS.txt"

          # Output newline-separated list for action-gh-release
          "files<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          ($paths -join "`n") | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: ${{ steps.relfiles.outputs.files }}
